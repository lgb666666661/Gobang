# 关于联机功能的Tcp报文格式约定

## 概述

网络联机功能需要约定一个协议格式来相互传递信息,**本项目选用了网络传输常用的JOSN数据格式**,现对其格式约定如下

## 共有字段

每段报文的JOSN信息必须有一个`type`的字段来标明是系统信息还是用户聊天信息

```json
{
    "type":"system" //可选值 system(系统信息) heart(心跳包信息) user(用户聊天信息)
}
```

## 心跳包

心跳包负责维护连接的状态,每0.5秒双方都要发一个如下格式的心跳包,如果一秒后收不到心跳包,系统会认为连接已断开,会暂停游戏并发送重连请求

```json
{"type":"heart"}
```

## 系统信息

### 下棋指令

用户下棋时需要发送这个信息

```json
{
    "type":"system",
    "do":"chess",
    "x":xx, //x,y 为要下的点坐标
    "y":xx,
    "color":"black", //或为white
    "isWin":"yes", //或为no 表示是否已经赢了
    "winInfo":"" //赢棋的原因可以写在这里,系统会显示到屏幕上
    
}
```

## 超时指令

用户超时时要发送,表示对方赢了

```json
{
    "type":"system",
    "do":"userTimeout",
    "winInfo":"" //赢棋的原因,系统会显示到屏幕上
}
```

## 悔棋

### 请求悔棋

用户想要悔棋会发送这个

```json
{
    "type":"system",
    "do":"requestRepent"
}
```

### 同意悔棋

用户同意悔棋时发送

```json
{
    "type":"system",
    "do":"agreeRepent"
}
```

### 拒绝悔棋

用户拒绝悔棋时发送

```json
{
    "type":"system",
    "do":"disagreeRepent"
}
```

## 拒绝棋局连接

因为用户可能因为加入房间界面刷新不及时导致连接一个已经开始游戏的服务器,所以服务器会发送这个拒绝请求,收到这个的用户需要主动断开连接

```json
{
    "type":"system",
    "do":"refuse"
}
```

## 重连请求

由于网络不稳定,所以可能会导致棋局断开后不同步的情况发生,所以每次建立连接都会发送一个重连请求来协调整个棋盘,使棋盘一致

```json
{
    "type":"system",
    "do":"reconnect",
    "record":xx //一个整数,表示已经下了多少步棋,系统根据这个信息调整棋盘
}
```

## 用户聊天信息

```json
{
    "type":"user",
    "message":"" //用户的聊天信息
}
```

